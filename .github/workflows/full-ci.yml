name: Full CI/CD – Backend + Frontend

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/full-ci.yml"

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io/${{ github.actor }}

    steps:
    # --------------------------------------------------
    # CHECKOUT
    # --------------------------------------------------
    - name: Checkout código
      uses: actions/checkout@v4

    # --------------------------------------------------
    # DOCKER BUILDX
    # --------------------------------------------------
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    # --------------------------------------------------
    # LOGIN GHCR
    # --------------------------------------------------
    - name: Login GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # ==================================================
    #  BACKEND - BUILD + PUSH
    # ==================================================
    - name: Build Backend
      run: |
        BACKEND_SHA="$REGISTRY/techroute-backend:${{ github.sha }}"
        BACKEND_LATEST="$REGISTRY/techroute-backend:latest"

        echo "BACKEND_SHA=$BACKEND_SHA" >> $GITHUB_ENV
        echo "BACKEND_LATEST=$BACKEND_LATEST" >> $GITHUB_ENV

        docker build -t $BACKEND_SHA -t $BACKEND_LATEST backend

    - name: Push Backend
      run: |
        docker push "$BACKEND_SHA"
        docker push "$BACKEND_LATEST"

    # ==================================================
    #  FRONTEND - BUILD + PUSH
    # ==================================================
    - name: Build Frontend
      run: |
        FRONTEND_SHA="$REGISTRY/techroute-frontend:${{ github.sha }}"
        FRONTEND_LATEST="$REGISTRY/techroute-frontend:latest"

        echo "FRONTEND_SHA=$FRONTEND_SHA" >> $GITHUB_ENV
        echo "FRONTEND_LATEST=$FRONTEND_LATEST" >> $GITHUB_ENV

        docker build -t $FRONTEND_SHA -t $FRONTEND_LATEST frontend

    - name: Push Frontend
      run: |
        docker push "$FRONTEND_SHA"
        docker push "$FRONTEND_LATEST"

    # ==================================================
    # INSTALL OC CLI
    # ==================================================
    - name: Install oc CLI
      run: |
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -o oc.tar.gz
        tar -xzvf oc.tar.gz
        sudo mv oc kubectl /usr/local/bin/
        sudo chmod +x /usr/local/bin/oc /usr/local/bin/kubectl

    # LOGIN OPENSHIFT
    # ==================================================
    - name: Login no OpenShift
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ secrets.OC_SERVER }}
        openshift_token: ${{ secrets.OC_TOKEN }}
        insecure_skip_tls_verify: true

    - name: Selecionar projeto
      run: |
        oc project ${{ secrets.OC_NAMESPACE }}

    # ==================================================
    # DEPLOY DO BACKEND
    # ==================================================
    - name: Atualizar Backend Deployment
      run: |
        oc set image deployment/backend backend="$BACKEND_LATEST" --record

    - name: Aguardar Rollout Backend
      run: |
        echo "Aguardando rollout do backend..."
        oc rollout status deployment/backend --timeout=180s || \
        (echo "Rollout do backend falhou" && oc logs deploy/backend && exit 1)

    # ==================================================
    # DEPLOY DO FRONTEND
    # ==================================================
    - name: Atualizar Frontend Deployment
      run: |
        oc set image deployment/frontend frontend="$FRONTEND_LATEST" --record

    - name: Aguardar Rollout Frontend
      run: |
        echo "Aguardando rollout do frontend..."
        oc rollout status deployment/frontend --timeout=180s || \
        (echo "Rollout do frontend falhou" && oc logs deploy/frontend && exit 1)

    # ==================================================
    # HEALTH CHECK FINAL
    # ==================================================
    - name: Health Check Final – Backend
      run: |
        URL="${{ secrets.BACKEND_ROUTE }}/health"
        echo "Testando $URL"
        curl -f "$URL" || (echo "HEALTH CHECK FALHOU" && exit 1)

    - name: Health Check Final – Frontend
      run: |
        URL="${{ secrets.FRONTEND_ROUTE }}"
        echo "Testando $URL"
        curl -f "$URL" || (echo "HEALTH CHECK FALHOU" && exit 1)

    - name: Deploy Concluído com Sucesso
      run: |
        echo "Deploy FULL concluído com sucesso!"

